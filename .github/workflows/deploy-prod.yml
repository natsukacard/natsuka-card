name: Deploy to Production

on:
  workflow_dispatch: # Manual "Toggle" button in GitHub
  push:
    branches:
      - main # Auto-runs on merge to main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # 1. Apply Schema Changes (Excludes internal_roles if not in migrations)
      - name: Link and Push Schema to Prod
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROD_PROJECT_ID }} --password ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # 2. Sync Reference Data (Dev -> Prod)
      - name: Sync Reference Data (Dev -> Prod)
        env:
          DEV_DB: ${{ secrets.SUPABASE_DB_URL_DEV }}
          PROD_DB: ${{ secrets.SUPABASE_DB_URL_PROD }}
        run: |
          # 1. Export Data from Dev (Using Dev Table Names)
          # We export 'pokemon_cards_en' and 'pokemon_sets_en' specifically
          pg_dump "$DEV_DB" \
            --data-only \
            --column-inserts \
            --table=public.pokemon_cards_en \
            --table=public.pokemon_sets_en \
            --table=public.pokemon_cards_jp \
            --table=public.pokemon_sets_jp \
            --table=public.card_prices \
            > dev_export.sql

          # 2. Rename Tables in SQL (Map '_en' -> Standard)
          # This replaces "public.pokemon_cards_en" with "public.pokemon_cards"
          sed 's/public.pokemon_cards_en/public.pokemon_cards/g' dev_export.sql > ref_data.sql
          # This replaces "public.pokemon_sets_en" with "public.pokemon_sets"
          sed -i 's/public.pokemon_sets_en/public.pokemon_sets/g' ref_data.sql

          # 3. Create Import Script (Disable Constraints + Truncate)
          echo "SET session_replication_role = 'replica';" > import.sql
          
          # Truncate tables to ensure a clean slate (avoids duplicates)
          echo "TRUNCATE TABLE public.pokemon_cards, public.pokemon_sets, public.pokemon_cards_jp, public.pokemon_sets_jp, public.card_prices CASCADE;" >> import.sql
          
          cat ref_data.sql >> import.sql
          echo "SET session_replication_role = 'origin';" >> import.sql

          # 4. Import to Prod
          psql "$PROD_DB" -f import.sql

      # 3. Sync Email Templates
      - name: Sync Email Templates
        run: node scripts/sync-email-templates.js
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          DEV_PROJECT_REF: ${{ secrets.SUPABASE_DEV_PROJECT_ID }}
          PROD_PROJECT_REF: ${{ secrets.SUPABASE_PROD_PROJECT_ID }}