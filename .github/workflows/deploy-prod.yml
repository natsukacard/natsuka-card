name: Deploy to Production

on:
  workflow_dispatch: # Manual "Toggle" button in GitHub
  push:
    branches:
      - main # Auto-runs on merge to main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # 1. Apply Schema Changes
      - name: Link and Push Schema to Prod
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROD_PROJECT_ID }} --password ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # 2. Sync Reference Data (Dev -> Prod)
      - name: Sync Reference Data (Dev -> Prod)
        env:
          DEV_DB: ${{ secrets.SUPABASE_DB_URL_DEV }}
          PROD_DB: ${{ secrets.SUPABASE_DB_URL_PROD }}
        run: |
          # 1. Export Data from Dev (Strictly the 4 core tables)
          pg_dump "$DEV_DB" \
            --data-only \
            --column-inserts \
            --table=public.pokemon_cards_en \
            --table=public.pokemon_sets_en \
            --table=public.pokemon_cards_jp \
            --table=public.pokemon_sets_jp \
            > ref_data.sql

          # 2. Create Import Script
          #    - Disable FK constraints to prevent ordering issues
          #    - TRUNCATE the 4 specific tables to clear old data/prevent duplicates
          echo "SET session_replication_role = 'replica';" > import.sql
          
          echo "TRUNCATE TABLE public.pokemon_cards_en, public.pokemon_sets_en, public.pokemon_cards_jp, public.pokemon_sets_jp CASCADE;" >> import.sql
          
          cat ref_data.sql >> import.sql
          echo "SET session_replication_role = 'origin';" >> import.sql

          # 3. Import to Prod
          psql "$PROD_DB" -f import.sql

      # 3. Sync Email Templates
      - name: Sync Email Templates
        run: node scripts/sync-email-templates.js
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          DEV_PROJECT_REF: ${{ secrets.SUPABASE_DEV_PROJECT_ID }}
          PROD_PROJECT_REF: ${{ secrets.SUPABASE_PROD_PROJECT_ID }}